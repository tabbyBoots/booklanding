@model mvcDapper3.Models.ViewModel.vmForgotPassword
@{
    ViewData["Title"] = "忘記密碼";
    Layout = "_BookLandingAuthLayout";
}

<!-- Forgot Password Form -->
<div class="auth-form-container" data-aos="fade-up">
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-icon">
                <i class="bi bi-key"></i>
            </div>
            <h2 class="auth-title">忘記密碼</h2>
            <p class="auth-subtitle">請輸入您的電子郵件地址，我們將向您發送重設密碼的連結</p>
        </div>

        <div class="auth-body">
            <form asp-controller="Account" asp-action="ForgotPassword" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                
                <!-- Email Field -->
                <div class="form-group mb-4">
                    <label asp-for="Email" class="form-label">
                        <i class="bi bi-envelope me-2"></i>電子郵件地址
                    </label>
                    <input asp-for="Email" class="form-control auth-input" placeholder="請輸入您的電子郵件地址" />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <!-- Captcha Section -->
                <div class="form-group mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <label asp-for="CaptchaCode" class="form-label">
                                <i class="bi bi-shield-check me-2"></i>驗證碼
                            </label>
                            <input asp-for="CaptchaCode" class="form-control auth-input" placeholder="請輸入驗證碼" />
                            <span asp-validation-for="CaptchaCode" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">驗證碼圖片</label>
                            <div class="captcha-container">
                                <img src="data:image/png;base64,@ViewBag.CaptchaImage" alt="Captcha" class="captcha-image" />
                                <button type="button" class="btn btn-link captcha-refresh" onclick="refreshCaptchaImg()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn auth-btn w-100 mb-4">
                    <i class="bi bi-send me-2"></i>發送重設連結
                </button>
            </form>

            <!-- Back to Login -->
            <div class="auth-links text-center">
                <a asp-action="Login" class="auth-link">
                    <i class="bi bi-arrow-left me-2"></i>返回登入
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Additional Styles -->
<style>
    .captcha-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border: 2px solid color-mix(in srgb, var(--default-color), transparent 85%);
        border-radius: 8px;
        background-color: var(--surface-color);
    }

    .captcha-image {
        height: 40px;
        width: 120px;
        border-radius: 4px;
        object-fit: contain;
    }

    .captcha-refresh {
        color: var(--accent-color);
        padding: 4px 8px;
        font-size: 1.2rem;
        border: none;
        background: none;
        transition: all 0.3s ease;
    }

    .captcha-refresh:hover {
        color: color-mix(in srgb, var(--accent-color), transparent 20%);
        transform: rotate(180deg);
    }

    .alert-danger {
        background-color: color-mix(in srgb, #dc3545, transparent 90%);
        border: 1px solid color-mix(in srgb, #dc3545, transparent 70%);
        color: #dc3545;
        border-radius: 8px;
        padding: 12px 16px;
        font-family: var(--default-font);
    }
</style>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Auto-load captcha on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Captcha is already loaded from the controller
        });

        function refreshCaptchaImg() {
            // Add timestamp to prevent caching
            const timestamp = new Date().getTime();
            fetch('/User/RefreshCaptchaImg?' + timestamp, {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Server returned status:', response.status);
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.captchaImage) {
                    // Update the image source with the base64 image data
                    document.querySelector('.captcha-image').src = 'data:image/png;base64,' + data.captchaImage;
                } else {
                    throw new Error('Invalid response format');
                }
            })
            .catch(error => {
                console.error('Error refreshing captcha:', error);
            });
        }
    </script>
}
